name: V4 Pipeline (SAFE: Feeder → Scorer → Telegram DUAL)

on:
  schedule:
    - cron: "30 7 * * *"
    - cron: "30 16 * * *"
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run feeder (affiliate-safe)
        env:
          DUFFEL_API_KEY: ${{ secrets.DUFFEL_API_KEY }}
          # Optional: add later when approved (won't error if missing)
          SKYSCANNER_AFFILIATE_ID: ${{ secrets.SKYSCANNER_AFFILIATE_ID }}
          GCP_SA_JSON: ${{ secrets.GCP_SA_JSON }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          RAW_DEALS_TAB: RAW_DEALS
          ORIGIN_IATA: LON
          DEST_IATA: BCN
          DAYS_AHEAD: "60"
          TRIP_LENGTH_DAYS: "5"
          MAX_INSERTS: "3"
        run: |
          python workers/duffel_feeder_v4_affiliate_safe.py

      - name: Run AI scorer
        env:
          GCP_SA_JSON: ${{ secrets.GCP_SA_JSON }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
        run: |
          python workers/ai_scorer.py

      - name: Publish Telegram (FREE+VIP from one file)
        env:
          GCP_SA_JSON: ${{ secrets.GCP_SA_JSON }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          RAW_DEALS_TAB: RAW_DEALS

          TELEGRAM_STATUS_COLUMN: status
          TELEGRAM_REQUIRED_STATUS: READY_TO_POST
          TELEGRAM_POSTED_STATUS: POSTED_TELEGRAM
          TELEGRAM_MAX_POSTS_PER_RUN: "1"

          TELEGRAM_BOT_TOKEN_FREE: ${{ secrets.TELEGRAM_BOT_TOKEN_FREE }}
          TELEGRAM_CHAT_ID_FREE: ${{ secrets.TELEGRAM_CHAT_ID_FREE }}

          TELEGRAM_BOT_TOKEN_VIP: ${{ secrets.TELEGRAM_BOT_TOKEN_VIP }}
          TELEGRAM_CHAT_ID_VIP: ${{ secrets.TELEGRAM_CHAT_ID_VIP }}

          STRIPE_LINK: ${{ secrets.STRIPE_LINK }}

          # Optional click tracking (works only if you deploy the PA redirect endpoint)
          REDIRECT_BASE_URL: ${{ secrets.REDIRECT_BASE_URL }}
        run: |
          python workers/telegram_publisher_V4.py
