name: V4.1 PRODUCTION (Streamlined - Error-Proof)

# Prevents overlapping runs
concurrency:
  group: v4_1_production
  cancel-in-progress: true

on:
  schedule:
    - cron: "30 7 * * *"   # 07:30 UTC
    - cron: "30 16 * * *"  # 16:30 UTC
  workflow_dispatch:

jobs:
  pipeline:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install gspread google-auth requests openai pillow

      # ============================================================
      # STEP 1: DUFFEL FEEDER (NEW)
      # ============================================================
      - name: "1Ô∏è‚É£ Duffel Feeder"
        id: feeder
        continue-on-error: true
        env:
          # Core secrets
          DUFFEL_API_KEY: ${{ secrets.DUFFEL_API_KEY }}
          GCP_SA_JSON: ${{ secrets.GCP_SA_JSON }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          
          # Config
          RAW_DEALS_TAB: "RAW_DEALS"
          RAW_STATUS_NEW: "NEW"
          MAX_INSERTS: "3"
          
          # Optional affiliate
          SKYSCANNER_AFFILIATE_ID: ${{ secrets.SKYSCANNER_AFFILIATE_ID }}
          
          # Route defaults
          ORIGIN_IATA: "LON"
          DEST_IATA: "BCN"
          DAYS_AHEAD: "60"
          TRIP_LENGTH_DAYS: "5"
        run: python workers/duffel_feeder_v4_affiliate_safe.py

      # ============================================================
      # STEP 2: AI SCORER (NEW ‚Üí READY_TO_POST)
      # ============================================================
      - name: "2Ô∏è‚É£ AI Scorer"
        id: scorer
        continue-on-error: true
        env:
          GCP_SA_JSON: ${{ secrets.GCP_SA_JSON }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          RAW_DEALS_TAB: "RAW_DEALS"
          
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
          
          INPUT_STATUS: "NEW"
          OUTPUT_STATUS: "READY_TO_POST"
          MAX_ROWS_PER_RUN: "1"
        run: python workers/ai_scorer.py

      # ============================================================
      # STEP 3: RENDER (READY_TO_POST ‚Üí READY_TO_PUBLISH)
      # ============================================================
      - name: "3Ô∏è‚É£ Render Graphics"
        id: render
        continue-on-error: true
        env:
          GCP_SA_JSON: ${{ secrets.GCP_SA_JSON }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          RAW_DEALS_TAB: "RAW_DEALS"
          
          RENDER_URL: ${{ secrets.RENDER_URL }}
          
          INPUT_STATUS: "READY_TO_POST"
          OUTPUT_STATUS: "READY_TO_PUBLISH"
          MAX_ROWS_PER_RUN: "1"
        run: python workers/render_worker.py

      # ============================================================
      # STEP 4: INSTAGRAM (READY_TO_PUBLISH ‚Üí POSTED_INSTAGRAM)
      # ============================================================
      - name: "4Ô∏è‚É£ Instagram Publish"
        id: instagram
        continue-on-error: true
        env:
          GCP_SA_JSON: ${{ secrets.GCP_SA_JSON }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          RAW_DEALS_TAB: "RAW_DEALS"
          
          IG_ACCESS_TOKEN: ${{ secrets.IG_ACCESS_TOKEN }}
          IG_USER_ID: ${{ secrets.IG_USER_ID }}
          
          INPUT_STATUS: "READY_TO_PUBLISH"
          OUTPUT_STATUS: "POSTED_INSTAGRAM"
          MAX_ROWS_PER_RUN: "1"
        run: python workers/publish_worker.py

      # ============================================================
      # STEP 5: TELEGRAM FREE (POSTED_INSTAGRAM ‚Üí POSTED_TELEGRAM_FREE)
      # ============================================================
      - name: "5Ô∏è‚É£ Telegram FREE"
        id: telegram_free
        continue-on-error: true
        env:
          GCP_SA_JSON: ${{ secrets.GCP_SA_JSON }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          RAW_DEALS_TAB: "RAW_DEALS"
          
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHANNEL: "-1003505750272"
          
          TELEGRAM_STATUS_COLUMN: "status"
          TELEGRAM_REQUIRED_STATUS: "POSTED_INSTAGRAM"
          TELEGRAM_POSTED_STATUS: "POSTED_TELEGRAM_FREE"
          TELEGRAM_MAX_POSTS_PER_RUN: "1"
          
          STRIPE_LINK: ${{ secrets.STRIPE_LINK }}
          TG_MODE: "free"
        run: python workers/telegram_publisher_v4.py

      # ============================================================
      # STEP 6: TELEGRAM VIP (POSTED_TELEGRAM_FREE ‚Üí POSTED_ALL)
      # ============================================================
      - name: "6Ô∏è‚É£ Telegram VIP"
        id: telegram_vip
        continue-on-error: true
        env:
          GCP_SA_JSON: ${{ secrets.GCP_SA_JSON }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          RAW_DEALS_TAB: "RAW_DEALS"
          
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHANNEL: "-1003517970522"
          
          TELEGRAM_STATUS_COLUMN: "status"
          TELEGRAM_REQUIRED_STATUS: "POSTED_TELEGRAM_FREE"
          TELEGRAM_POSTED_STATUS: "POSTED_ALL"
          TELEGRAM_MAX_POSTS_PER_RUN: "1"
          
          TG_MODE: "vip"
        run: python workers/telegram_publisher_v4.py

      # ============================================================
      # SUMMARY
      # ============================================================
      - name: "üìä Pipeline Summary"
        if: always()
        run: |
          echo "==================================="
          echo "V4.1 PIPELINE SUMMARY"
          echo "==================================="
          echo "Feeder:    ${{ steps.feeder.outcome }}"
          echo "Scorer:    ${{ steps.scorer.outcome }}"
          echo "Render:    ${{ steps.render.outcome }}"
          echo "Instagram: ${{ steps.instagram.outcome }}"
          echo "Tg FREE:   ${{ steps.telegram_free.outcome }}"
          echo "Tg VIP:    ${{ steps.telegram_vip.outcome }}"
          echo "==================================="
