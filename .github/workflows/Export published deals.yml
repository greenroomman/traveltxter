name: Export published deals (Landing Page Feed)

on:
  workflow_dispatch:
  schedule:
    # Runs after PM slot completes
    - cron: "50 16 * * *"   # 16:50 UTC
    # Optional AM refresh
    - cron: "50 06 * * *"   # 06:50 UTC

jobs:
  export:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install gspread google-auth oauth2client

      - name: Export published deals (max 3)
        env:
          # Google / Sheets
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          SHEET_ID: ${{ secrets.SHEET_ID }}
          RAW_DEALS_TAB: ${{ secrets.RAW_DEALS_TAB }}
          GCP_SA_JSON_ONE_LINE: ${{ secrets.GCP_SA_JSON_ONE_LINE }}

        run: |
          echo "▶ Running exporter"
          python workers/export_published_deals.py

          echo "▶ Verifying outputs"
          test -f public/deals.json || (echo "❌ public/deals.json missing" && exit 1)

          # Ensure frontend public exists
          mkdir -p frontend/public

          # HARD SYNC: frontend always mirrors root
          cp public/deals.json frontend/public/deals.json

          echo "▶ Deal counts:"
          python - <<'PY'
          import json
          r = json.load(open("public/deals.json"))
          f = json.load(open("frontend/public/deals.json"))
          print("root count:", r.get("count"))
          print("frontend count:", f.get("count"))
          assert r.get("count") == f.get("count"), "❌ frontend feed out of sync"
          PY

      - name: Commit updated feeds
        run: |
          git config user.name "TravelTxter Export Bot"
          git config user.email "bot@traveltxter.com"

          git add public/deals.json frontend/public/deals.json

          # Only commit if something actually changed
          if git diff --cached --quiet; then
            echo "ℹ️ No feed changes to commit"
          else
            git commit -m "Update landing page deals feed (max 3)"
            git push
          fi
