name: TravelTxter V5 Pipeline

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Run mode: full or feeder_only"
        required: true
        default: "full"
        type: choice
        options:
          - full
          - feeder_only
      run_slot:
        description: "Time slot: AM or PM (for manual testing)"
        required: true
        default: "PM"
        type: choice
        options:
          - AM
          - PM
  schedule:
    # DST-safe: trigger around both GMT and BST equivalents.
    # Guard step below ensures we only run at 06:30 and 16:30 Europe/London.
    - cron: "30 5 * * *"    # 06:30 BST
    - cron: "30 6 * * *"    # 06:30 GMT
    - cron: "30 15 * * *"   # 16:30 BST
    - cron: "30 16 * * *"   # 16:30 GMT

concurrency:
  group: traveltxter-v5-pipeline
  cancel-in-progress: false

jobs:
  pipeline:
    runs-on: ubuntu-latest
    env:
      MODE: ${{ inputs.mode || 'full' }}
      RUN_SLOT: ${{ inputs.run_slot || 'PM' }} # overwritten for scheduled runs by guard step

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # =========================
      # SLOT GUARD (DST-SAFE)
      # =========================
      - name: Determine UK-local slot (06:30/16:30 only)
        if: ${{ github.event_name == 'schedule' }}
        run: |
          set -e
          python - <<'PY'
          from datetime import datetime
          from zoneinfo import ZoneInfo

          now_uk = datetime.now(ZoneInfo("Europe/London"))
          hhmm = now_uk.strftime("%H:%M")

          if hhmm == "06:30":
              run_slot = "AM"
          elif hhmm == "16:30":
              run_slot = "PM"
          else:
              # Not our intended local slot; exit cleanly.
              print(f"UK local time is {hhmm}; not 06:30 or 16:30 -> exiting.")
              raise SystemExit(0)

          # Export RUN_SLOT for downstream steps
          print(f"RUN_SLOT={run_slot}")
          with open("${GITHUB_ENV}", "a") as f:
              f.write(f"RUN_SLOT={run_slot}\n")
          PY

      - name: Install deps
        run: |
          set -e
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # =========================
      # 1) FEEDER
      # =========================
      - name: Feeder (pipeline_worker.py)
        env:
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          SHEET_ID: ${{ secrets.SHEET_ID }}
          GCP_SA_JSON: ${{ secrets.GCP_SA_JSON }}
          GCP_SA_JSON_ONE_LINE: ${{ secrets.GCP_SA_JSON_ONE_LINE }}
          RAW_DEALS_TAB: ${{ secrets.RAW_DEALS_TAB }}
          FEEDER_CONFIG_TAB: CONFIG
          OPS_MASTER_TAB: OPS_MASTER
          DUFFEL_API_KEY: ${{ secrets.DUFFEL_API_KEY }}
          # feeder caps
          DUFFEL_MAX_SEARCHES_PER_RUN: ${{ vars.DUFFEL_MAX_SEARCHES_PER_RUN || '12' }}
          DUFFEL_MAX_INSERTS: ${{ vars.DUFFEL_MAX_INSERTS || '50' }}
          DUFFEL_MAX_INSERTS_PER_ORIGIN: ${{ vars.DUFFEL_MAX_INSERTS_PER_ORIGIN || '15' }}
          DUFFEL_MAX_INSERTS_PER_ROUTE: ${{ vars.DUFFEL_MAX_INSERTS_PER_ROUTE || '5' }}
          DUFFEL_ROUTES_PER_RUN: ${{ vars.DUFFEL_ROUTES_PER_RUN || '6' }}
          MIN_INGEST_AGE_SECONDS: ${{ vars.MIN_INGEST_AGE_SECONDS || '90' }}
          VARIETY_LOOKBACK_HOURS: ${{ vars.VARIETY_LOOKBACK_HOURS || '120' }}
        run: |
          set -e
          python workers/pipeline_worker.py

      # If you dispatch feeder_only, we stop right here.
      - name: Stop after feeder (feeder_only)
        if: ${{ (inputs.mode || 'full') == 'feeder_only' }}
        run: |
          echo "MODE=feeder_only -> stopping after feeder."
          exit 0

      # =========================
      # PAUSE (IMPORTANT)
      # =========================
      - name: Pause 30s for Sheets consistency
        run: |
          echo "Sleeping 30 seconds to allow Sheets to settle before scoring..."
          sleep 30

      # =========================
      # 2) SCORER
      # =========================
      - name: Scorer (ai_scorer.py)
        env:
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          SHEET_ID: ${{ secrets.SHEET_ID }}
          GCP_SA_JSON: ${{ secrets.GCP_SA_JSON }}
          GCP_SA_JSON_ONE_LINE: ${{ secrets.GCP_SA_JSON_ONE_LINE }}
          RAW_DEALS_TAB: ${{ secrets.RAW_DEALS_TAB }}
          RAW_DEALS_VIEW_TAB: RAW_DEALS_VIEW
          OPS_MASTER_TAB: OPS_MASTER
          MIN_INGEST_AGE_SECONDS: ${{ vars.MIN_INGEST_AGE_SECONDS || '90' }}
        run: |
          set -e
          python workers/ai_scorer.py

      # =========================
      # 3) ENRICH
      # =========================
      - name: Enrich (enrich_router.py)
        env:
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          SHEET_ID: ${{ secrets.SHEET_ID }}
          GCP_SA_JSON: ${{ secrets.GCP_SA_JSON }}
          GCP_SA_JSON_ONE_LINE: ${{ secrets.GCP_SA_JSON_ONE_LINE }}
          RAW_DEALS_TAB: ${{ secrets.RAW_DEALS_TAB }}
          PHRASE_BANK_TAB: PHRASE_BANK
          IATA_MASTER_TAB: IATA_MASTER
          PHRASE_CHANNEL: ${{ vars.PHRASE_CHANNEL || 'vip' }}
          ENRICH_MAX_ROWS_PER_RUN: ${{ vars.ENRICH_MAX_ROWS_PER_RUN || '60' }}
          ENFORCE_MAX_PER_MONTH: ${{ vars.ENFORCE_MAX_PER_MONTH || 'true' }}
          REQUIRE_PHRASE: ${{ vars.REQUIRE_PHRASE || 'false' }}
        run: |
          set -e
          python workers/enrich_router.py

      # =========================
      # 4) RENDER
      # =========================
      - name: Render (render_client.py)
        continue-on-error: true
        env:
          MODE: full
          RUN_SLOT: ${{ env.RUN_SLOT }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          SHEET_ID: ${{ secrets.SHEET_ID }}
          GCP_SA_JSON: ${{ secrets.GCP_SA_JSON }}
          GCP_SA_JSON_ONE_LINE: ${{ secrets.GCP_SA_JSON_ONE_LINE }}
          RAW_DEALS_TAB: ${{ secrets.RAW_DEALS_TAB }}
          RAW_DEALS_VIEW_TAB: RAW_DEALS_VIEW
          OPS_MASTER_TAB: OPS_MASTER
          RENDER_BASE_URL: ${{ secrets.RENDER_URL }}
          RENDER_MAX_ROWS: ${{ vars.RENDER_MAX_ROWS || '2' }}
        run: |
          set -e
          python workers/render_client.py

      # =========================
      # 5) INSTAGRAM (marketing; must not block TG)
      # =========================
      - name: Instagram Publisher (instagram_publisher.py)
        continue-on-error: true
        env:
          MODE: full
          RUN_SLOT: ${{ env.RUN_SLOT }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          SHEET_ID: ${{ secrets.SHEET_ID }}
          GCP_SA_JSON: ${{ secrets.GCP_SA_JSON }}
          GCP_SA_JSON_ONE_LINE: ${{ secrets.GCP_SA_JSON_ONE_LINE }}
          RAW_DEALS_TAB: ${{ secrets.RAW_DEALS_TAB }}
          RAW_DEALS_VIEW_TAB: RAW_DEALS_VIEW
          OPS_MASTER_TAB: OPS_MASTER
          IG_ACCESS_TOKEN: ${{ secrets.IG_ACCESS_TOKEN }}
          IG_USER_ID: ${{ secrets.IG_USER_ID }}
          GRAPH_API_VERSION: ${{ vars.GRAPH_API_VERSION || 'v20.0' }}
          VARIETY_LOOKBACK_HOURS: ${{ vars.VARIETY_LOOKBACK_HOURS || '120' }}
          MIN_INGEST_AGE_SECONDS: ${{ vars.MIN_INGEST_AGE_SECONDS || '90' }}
        run: |
          set -e
          python workers/instagram_publisher.py

      # =========================
      # 6) LINK ROUTER
      # =========================
      - name: Link Router (link_router.py)
        continue-on-error: true
        env:
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          SHEET_ID: ${{ secrets.SHEET_ID }}
          GCP_SA_JSON: ${{ secrets.GCP_SA_JSON }}
          GCP_SA_JSON_ONE_LINE: ${{ secrets.GCP_SA_JSON_ONE_LINE }}
          RAW_DEALS_TAB: ${{ secrets.RAW_DEALS_TAB }}
          FALLBACK_STRATEGY: ${{ vars.FALLBACK_STRATEGY || 'google' }}
          DUFFEL_LINKS_ENABLED: ${{ vars.DUFFEL_LINKS_ENABLED || 'false' }}
          REDIRECT_BASE_URL: ${{ secrets.REDIRECT_BASE_URL }}
          TRAVELUP_ENABLED: ${{ vars.TRAVELUP_ENABLED || 'true' }}
          TRAVELUP_CJ_CLICK_BASE: ${{ secrets.TRAVELUP_CJ_CLICK_BASE }}
        run: |
          set -e
          python workers/link_router.py

      # =========================
      # 7) TELEGRAM (VIP first, then FREE)
      # =========================
      - name: Telegram Publisher (telegram_publisher.py)
        env:
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          SHEET_ID: ${{ secrets.SHEET_ID }}
          GCP_SA_JSON: ${{ secrets.GCP_SA_JSON }}
          GCP_SA_JSON_ONE_LINE: ${{ secrets.GCP_SA_JSON_ONE_LINE }}
          RAW_DEALS_TAB: ${{ secrets.RAW_DEALS_TAB }}
          RAW_DEALS_VIEW_TAB: RAW_DEALS_VIEW
          OPS_MASTER_TAB: OPS_MASTER
          TELEGRAM_BOT_TOKEN_VIP: ${{ secrets.TELEGRAM_BOT_TOKEN_VIP }}
          TELEGRAM_CHANNEL_VIP: ${{ secrets.TELEGRAM_CHANNEL_VIP }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHANNEL: ${{ secrets.TELEGRAM_CHANNEL }}
          STRIPE_LINK_MONTHLY: ${{ secrets.STRIPE_LINK_MONTHLY }}
          STRIPE_LINK_YEARLY: ${{ secrets.STRIPE_LINK_YEARLY }}
          MIN_INGEST_AGE_SECONDS: ${{ vars.MIN_INGEST_AGE_SECONDS || '90' }}
          AM_RUN_TIME_UTC: "07:30"
          PM_RUN_TIME_UTC: "16:30"
        run: |
          set -e
          python workers/telegram_publisher.py
