name: TravelTxter V4.5x Pipeline

on:
  workflow_dispatch:
  schedule:
    - cron: "30 7 * * *"
    - cron: "30 16 * * *"

concurrency:
  group: v45x-pipeline
  cancel-in-progress: false

jobs:
  pipeline:
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Resolve RUN_SLOT
        shell: bash
        run: |
          HOUR=$(date -u +%H)
          if [ "$HOUR" -lt 12 ]; then
            RUN_SLOT=AM
          else
            RUN_SLOT=PM
          fi
          echo "RUN_SLOT=$RUN_SLOT" >> $GITHUB_ENV
          echo "Resolved RUN_SLOT=$RUN_SLOT"

      # ================= AM RUN =================

      - name: AM — Pipeline worker
        if: env.RUN_SLOT == 'AM'
        run: |
          python workers/pipeline_worker.py

      - name: AM — Link router
        if: env.RUN_SLOT == 'AM'
        run: |
          python workers/link_router.py

      - name: AM — Render client
        if: env.RUN_SLOT == 'AM'
        run: |
          python workers/render_client.py

      - name: AM — Instagram publisher
        if: env.RUN_SLOT == 'AM'
        run: |
          python workers/instagram_publisher.py

      - name: AM — Telegram VIP publisher
        if: env.RUN_SLOT == 'AM'
        run: |
          python workers/telegram_publisher.py

      # ================= PM RUN =================

      - name: PM — Telegram FREE publisher
        if: env.RUN_SLOT == 'PM'
        run: |
          python workers/telegram_publisher.py
