name: TravelTxter Pipeline (V4.6 â€“ Supply Unlocked)

on:
  workflow_dispatch:
  schedule:
    - cron: "30 7 * * *"
    - cron: "30 16 * * *"

concurrency:
  group: traveltxter-pipeline
  cancel-in-progress: false

jobs:
  pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # -----------------------------
      # FEEDER (SUPPLY ENGINE)
      # -----------------------------
      - name: Run Feeder
        run: python workers/pipeline_worker.py
        env:
          # ---- Secrets ----
          DUFFEL_API_KEY: ${{ secrets.DUFFEL_API_KEY }}
          GCP_SA_JSON_ONE_LINE: ${{ secrets.GCP_SA_JSON_ONE_LINE }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}

          # ---- Sheet tabs (LOCKED) ----
          RAW_DEALS_TAB: RAW_DEALS
          CONFIG_TAB: CONFIG
          THEMES_TAB: THEMES
          SIGNALS_TAB: CONFIG_SIGNALS
          CAPABILITY_TAB: ROUTE_CAPABILITY_MAP

          # ---- SUPPLY PRESSURE (CRITICAL) ----
          DUFFEL_MAX_INSERTS: 50
          DUFFEL_OFFERS_PER_SEARCH: 50
          DUFFEL_ROUTES_PER_RUN: 8
          DUFFEL_MAX_SEARCHES_PER_RUN: 8

          # ---- ORIGIN DIVERSITY ----
          FEEDER_OPEN_ORIGINS: "true"
          RESPECT_CONFIG_ORIGIN: "false"

          # ---- Timing / pacing ----
          FEEDER_SLEEP_SECONDS: 0.4

      # -----------------------------
      # WAIT FOR SHEET RECALC
      # -----------------------------
      - name: Wait for Google Sheets recalculation
        run: sleep 90

      # -----------------------------
      # SCORER
      # -----------------------------
      - name: Run AI Scorer
        run: python workers/ai_scorer.py
        env:
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          RAW_DEALS_TAB: RAW_DEALS
          MIN_INGEST_AGE_SECONDS: 90
          WINNERS_PER_RUN: 1
          VARIETY_LOOKBACK_HOURS: 120

      # -----------------------------
      # LINK ROUTER
      # -----------------------------
      - name: Run Link Router
        run: python workers/link_router.py
        env:
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          RAW_DEALS_TAB: RAW_DEALS
          DUFFEL_API_KEY: ${{ secrets.DUFFEL_API_KEY }}
          REDIRECT_BASE_URL: ${{ secrets.REDIRECT_BASE_URL }}

      # -----------------------------
      # RENDER
      # -----------------------------
      - name: Run Renderer
        run: python workers/render_client.py
        env:
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          RAW_DEALS_TAB: RAW_DEALS
          RENDER_URL: ${{ secrets.RENDER_URL }}
          RENDER_MAX_ROWS: 1

      # -----------------------------
      # INSTAGRAM
      # -----------------------------
      - name: Publish Instagram
        run: python workers/instagram_publisher.py
        env:
          IG_ACCESS_TOKEN: ${{ secrets.IG_ACCESS_TOKEN }}
          IG_USER_ID: ${{ secrets.IG_USER_ID }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}

      # -----------------------------
      # TELEGRAM
      # -----------------------------
      - name: Publish Telegram
        run: python workers/telegram_publisher.py
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHANNEL: ${{ secrets.TELEGRAM_CHANNEL }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
