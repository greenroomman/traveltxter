name: V4.1 UNIFIED PIPELINE

concurrency:
  group: v4_1_unified
  cancel-in-progress: true

on:
  schedule:
    - cron: "30 7 * * *"   # 06:30 UTC
    - cron: "30 16 * * *"  # 16:30 UTC
  workflow_dispatch:

jobs:
  pipeline:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install gspread google-auth requests openai

      # ============================================================
      # STAGE 1: AI SCORER (includes Duffel feeder if API key set)
      # ============================================================
      - name: "1Ô∏è‚É£ AI Scorer (+ Duffel Feeder)"
        env:
          GCP_SA_JSON: ${{ secrets.GCP_SA_JSON }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          RAW_DEALS_TAB: "RAW_DEALS"
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
          # Duffel feeder (V4.2 - multi-airport, high volume)
          DUFFEL_API_KEY: ${{ secrets.DUFFEL_API_KEY }}
          DUFFEL_MAX_INSERTS: "20"  # Get all offers (not just 1)
        run: python unified_pipeline_worker.py

      # ============================================================
      # STAGE 2: RENDER (READY_TO_POST ‚Üí READY_TO_PUBLISH)
      # ============================================================
      - name: "2Ô∏è‚É£ Render Graphics"
        env:
          GCP_SA_JSON: ${{ secrets.GCP_SA_JSON }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          RAW_DEALS_TAB: "RAW_DEALS"
          RENDER_URL: ${{ secrets.RENDER_URL }}
        run: python unified_pipeline_worker.py

      # ============================================================
      # STAGE 4: INSTAGRAM (READY_TO_PUBLISH ‚Üí POSTED_INSTAGRAM)
      # ============================================================
      - name: "4Ô∏è‚É£ Instagram Publish"
        env:
          GCP_SA_JSON: ${{ secrets.GCP_SA_JSON }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          RAW_DEALS_TAB: "RAW_DEALS"
          IG_ACCESS_TOKEN: ${{ secrets.IG_ACCESS_TOKEN }}
          IG_USER_ID: ${{ secrets.IG_USER_ID }}
        run: python unified_pipeline_worker.py

      # ============================================================
      # STAGE 5: TELEGRAM FREE / RAMBLER (POSTED_INSTAGRAM ‚Üí POSTED_TELEGRAM_FREE)
      # ============================================================
      - name: "5Ô∏è‚É£ Telegram FREE (Rambler)"
        env:
          GCP_SA_JSON: ${{ secrets.GCP_SA_JSON }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          RAW_DEALS_TAB: "RAW_DEALS"
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_FREE_CHANNEL: "-1003505750272"
        run: python unified_pipeline_worker.py

      # ============================================================
      # STAGE 6: TELEGRAM MONTHLY / ADVENTURER (POSTED_TELEGRAM_FREE ‚Üí POSTED_TELEGRAM_MONTHLY)
      # ============================================================
      - name: "6Ô∏è‚É£ Telegram MONTHLY (Adventurer - ¬£3/month)"
        env:
          GCP_SA_JSON: ${{ secrets.GCP_SA_JSON }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          RAW_DEALS_TAB: "RAW_DEALS"
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_MONTHLY_CHANNEL: "-1003517970522"
        run: python unified_pipeline_worker.py

      # ============================================================
      # STAGE 7: TELEGRAM ANNUAL / NOMAD (POSTED_TELEGRAM_MONTHLY ‚Üí POSTED_ALL)
      # ============================================================
      - name: "7Ô∏è‚É£ Telegram ANNUAL (Nomad - ¬£30/year)"
        env:
          GCP_SA_JSON: ${{ secrets.GCP_SA_JSON }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          RAW_DEALS_TAB: "RAW_DEALS"
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_ANNUAL_CHANNEL: "-1003517970522"
        run: python unified_pipeline_worker.py

      # ============================================================
      # SUMMARY
      # ============================================================
      - name: "üìä Pipeline Summary"
        if: always()
        run: |
          echo "==================================="
          echo "V4.1 UNIFIED PIPELINE SUMMARY"
          echo "==================================="
          echo "All stages complete"
          echo "Check logs for deal progression"
          echo "==================================="
