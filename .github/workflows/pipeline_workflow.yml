# .github/workflows/pipeline_workflow.yml
#
# TRAVELTXTER â€” V5 PIPELINE (CANONICAL)
#
# PURPOSE
# - Run the full deterministic spreadsheet-led pipeline twice daily (AM + PM).
# - Workers are stateless; Google Sheets (RAW_DEALS) is the only stateful memory.
# - RAW_DEALS_VIEW is read-only (formula projection); NEVER written by workers.
#
# ORDER (V5)
# 1) pipeline_worker.py       (feeder; inserts NEW rows into RAW_DEALS)
# 2) ai_scorer.py             (promotes NEW -> PUBLISH_AM/PUBLISH_PM/PUBLISH_BOTH and/or SCORED)
# 3) enrich_router.py         (fills city/country + phrase_bank; does NOT touch status)
# 4) render_client.py         (writes graphic_url + render timestamps/errors; does NOT touch status)
# 5) instagram_publisher.py   (posts IG; sets PUBLISH_* -> READY_TO_POST; writes posted_instagram_at)
# 6) link_router.py           (writes booking_link_vip; does NOT touch status)
# 7) telegram_publisher.py    (VIP then FREE; READY_TO_POST -> VIP_DONE -> PUBLISHED)
#
# RUN_SLOT
# - RUN_SLOT=AM or RUN_SLOT=PM is passed to workers (publish windows + -1 run FREE lag logic).
# - Render layout is derived from ingested_at_utc, NOT RUN_SLOT (locked rule).
#
# NOTE
# - This workflow assumes each worker reads its own required TAB names from env vars.
# - Do not rename tabs/headers without updating workers.

name: TravelTxter V5 Pipeline

on:
  workflow_dispatch:
  schedule:
    - cron: "30 7 * * *"   # 07:30 UTC (AM)
    - cron: "30 16 * * *"  # 16:30 UTC (PM)

concurrency:
  group: traveltxter-v5-pipeline
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        slot: [AM, PM]

    # Only run the matching matrix slot for the current schedule time.
    # For workflow_dispatch, both slots run (useful for testing).
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'schedule' && (
        (matrix.slot == 'AM' && github.event.schedule == '30 7 * * *') ||
        (matrix.slot == 'PM' && github.event.schedule == '30 16 * * *')
      ))

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run V5 pipeline (slot=${{ matrix.slot }})
        env:
          # Core
          RUN_SLOT: ${{ matrix.slot }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          SHEET_ID: ${{ secrets.SHEET_ID }}

          # Service account JSON (either is fine; workers handle both)
          GCP_SA_JSON: ${{ secrets.GCP_SA_JSON }}
          GCP_SA_JSON_ONE_LINE: ${{ secrets.GCP_SA_JSON_ONE_LINE }}

          # Tabs (never assume; keep explicit)
          RAW_DEALS_TAB: ${{ secrets.RAW_DEALS_TAB }}
          RAW_DEALS_VIEW_TAB: RAW_DEALS_VIEW
          OPS_MASTER_TAB: OPS_MASTER
          FEEDER_CONFIG_TAB: CONFIG
          THEMES_TAB: THEMES
          PHRASE_BANK_TAB: PHRASE_BANK
          IATA_MASTER_TAB: IATA_MASTER
          CONFIG_CARRIER_BIAS_TAB: CONFIG_CARRIER_BIAS
          ROUTE_CAPABILITY_MAP_TAB: ROUTE_CAPABILITY_MAP
          ZONE_THEME_BENCHMARKS_TAB: ZONE_THEME_BENCHMARKS

          # Duffel
          DUFFEL_API_KEY: ${{ secrets.DUFFEL_API_KEY }}
          DUFFEL_BUDGET_GBP: ${{ vars.DUFFEL_BUDGET_GBP }}
          DUFFEL_EXCESS_SEARCH_USD: ${{ vars.DUFFEL_EXCESS_SEARCH_USD }}
          DUFFEL_MAX_INSERTS: ${{ vars.DUFFEL_MAX_INSERTS }}
          DUFFEL_MAX_INSERTS_PER_ORIGIN: ${{ vars.DUFFEL_MAX_INSERTS_PER_ORIGIN }}
          DUFFEL_MAX_INSERTS_PER_ROUTE: ${{ vars.DUFFEL_MAX_INSERTS_PER_ROUTE }}
          DUFFEL_MAX_SEARCHES_PER_RUN: ${{ vars.DUFFEL_MAX_SEARCHES_PER_RUN }}
          DUFFEL_ROUTES_PER_RUN: ${{ vars.DUFFEL_ROUTES_PER_RUN }}

          # Render
          RENDER_URL: ${{ secrets.RENDER_URL }}

          # Link routing / redirects
          REDIRECT_BASE_URL: ${{ secrets.REDIRECT_BASE_URL }}

          # Instagram
          IG_ACCESS_TOKEN: ${{ secrets.IG_ACCESS_TOKEN }}
          IG_USER_ID: ${{ secrets.IG_USER_ID }}
          GRAPH_API_VERSION: ${{ vars.GRAPH_API_VERSION }}
          VARIETY_LOOKBACK_HOURS: ${{ vars.VARIETY_LOOKBACK_HOURS }}
          MIN_INGEST_AGE_SECONDS: ${{ vars.MIN_INGEST_AGE_SECONDS }}

          # Phrase selection controls
          PHRASE_CHANNEL: vip
          ENRICH_MAX_ROWS_PER_RUN: ${{ vars.ENRICH_MAX_ROWS_PER_RUN }}
          ENFORCE_MAX_PER_MONTH: ${{ vars.ENFORCE_MAX_PER_MONTH }}
          REQUIRE_PHRASE: false

          # Telegram
          TELEGRAM_BOT_TOKEN_VIP: ${{ secrets.TELEGRAM_BOT_TOKEN_VIP }}
          TELEGRAM_CHANNEL_VIP: ${{ secrets.TELEGRAM_CHANNEL_VIP }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHANNEL: ${{ secrets.TELEGRAM_CHANNEL }}

          # Stripe links (FREE upsell)
          STRIPE_LINK_MONTHLY: ${{ secrets.STRIPE_LINK_MONTHLY }}
          STRIPE_LINK_YEARLY: ${{ secrets.STRIPE_LINK_YEARLY }}

          # Schedule window times (used by TG publisher for true -1 run lag)
          AM_RUN_TIME_UTC: "07:30"
          PM_RUN_TIME_UTC: "16:30"

        run: |
          set -e

          echo "=============================="
          echo "TravelTxter V5 Pipeline"
          echo "RUN_SLOT=${RUN_SLOT}"
          echo "=============================="

          # 1) FEEDER
          python workers/pipeline_worker.py

          # 2) SCORER (writes PUBLISH_AM/PUBLISH_PM/PUBLISH_BOTH + SCORED)
          python workers/ai_scorer.py

          # 3) ENRICH (IATA backfill + phrase_bank)
          python workers/enrich_router.py

          # 4) RENDER (graphic_url + timestamps; theme via RDV dynamic_theme)
          python workers/render_client.py

          # 5) IG PUBLISH (must flip PUBLISH_* -> READY_TO_POST)
          python workers/instagram_publisher.py

          # 6) LINK ROUTER (booking_link_vip)
          python workers/link_router.py

          # 7) TELEGRAM (VIP then FREE; READY_TO_POST -> VIP_DONE -> PUBLISHED)
          python workers/telegram_publisher.py
