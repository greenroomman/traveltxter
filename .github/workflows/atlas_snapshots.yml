name: Atlas Snapshots

on:
  schedule:
    - cron: '10 7 * * *'
  workflow_dispatch:

jobs:

  capture:
    name: Capture Snapshots
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests gspread google-auth

      - name: Run capture
        env:
          GCP_SA_JSON_ONE_LINE: ${{ secrets.GCP_SA_JSON_ONE_LINE }}
          DUFFEL_API_KEY: ${{ secrets.DUFFEL_API_KEY }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          SNAPSHOT_LOG_TAB: SNAPSHOT_LOG
          ATLAS_CONFIG_PATH: config/atlas_snapshot_config.json
          ATLAS_MAX_SEARCHES: 90 
          FEEDER_SLEEP_SECONDS: 0.5
        run: python workers/atlas_snapshot_capture.py

  backfill:
    name: Backfill Outcomes
    runs-on: ubuntu-latest
    needs: capture
    if: always()
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests gspread google-auth

      - name: Run backfill
        env:
          GCP_SA_JSON_ONE_LINE: ${{ secrets.GCP_SA_JSON_ONE_LINE }}
          DUFFEL_API_KEY: ${{ secrets.DUFFEL_API_KEY }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          SNAPSHOT_LOG_TAB: SNAPSHOT_LOG
          ATLAS_BACKFILL_MAX: 50
          ATLAS_CABIN_CLASS: economy
          ATLAS_MAX_CONNECTIONS: 1
          FEEDER_SLEEP_SECONDS: 0.5
        run: python workers/atlas_snapshot_backfill.py
