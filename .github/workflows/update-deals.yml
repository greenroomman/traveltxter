# =============================================================================
# TravelTxter V5 — Website Deal Updater
# =============================================================================
# Schedule: Twice daily (AM + PM aligned to UK time)
#   - 07:30 UTC → AM deals live before morning audience
#   - 16:30 UTC → PM deals live before evening audience
#
# What it does:
#   1. Reads RAW_DEALS from Google Sheets (read-only)
#   2. Writes public/data/deals.json
#   3. Commits + pushes → Vercel auto-deploys
#
# This worker is stateless. It does not write to Sheets.
# =============================================================================

name: Update Website Deals

on:
  schedule:
    # AM run — 07:30 UTC (07:30 GMT / 08:30 BST)
    - cron: '30 7 * * *'
    # PM run — 16:30 UTC (16:30 GMT / 17:30 BST)
    - cron: '30 16 * * *'

  # Manual trigger for testing / emergency refresh
  workflow_dispatch:

# Prevent overlapping runs
concurrency:
  group: deal-update
  cancel-in-progress: false

jobs:
  fetch-and-commit:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      # ------------------------------------------
      # 1. Checkout repo
      # ------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # ------------------------------------------
      # 2. Set up Python
      # ------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # ------------------------------------------
      # 3. Install dependencies
      # ------------------------------------------
      - name: Install dependencies
        run: |
          pip install gspread google-auth

      # ------------------------------------------
      # 4. Run the fetcher
      # ------------------------------------------
      - name: Fetch deals from Google Sheets
        env:
          GOOGLE_SPREADSHEET_ID: ${{ secrets.GOOGLE_SPREADSHEET_ID }}
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
        run: |
          python scripts/fetch_deals.py

      # ------------------------------------------
      # 5. Commit and push (only if changed)
      # ------------------------------------------
      - name: Commit updated deals
        run: |
          git config user.name "TravelTxter Bot"
          git config user.email "bot@traveltxter.com"

          # Stage the deals file
          git add public/data/deals.json

          # Only commit if there are actual changes
          if git diff --cached --quiet; then
            echo "No changes to deals.json — skipping commit"
          else
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
            DEAL_COUNT=$(python -c "import json; d=json.load(open('public/data/deals.json')); print(d.get('deal_count', 0))")
            git commit -m "chore: update deals (${DEAL_COUNT} deals) — ${TIMESTAMP}"
            git push
            echo "OK: Committed and pushed. Vercel will auto-deploy."
          fi
