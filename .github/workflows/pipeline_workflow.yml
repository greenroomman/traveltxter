={"fatigue_penalty"; ARRAYFORMULA(
LET(
  rd_hdrs, RAW_DEALS!$1:$1,
  rd_body, RAW_DEALS!$A$2:$ZZ,

  col_id, MATCH("deal_id", rd_hdrs, 0),
  ids, INDEX(rd_body, , col_id),

  col_dest, MATCH("destination_iata", rd_hdrs, 0),
  dest, INDEX(rd_body, , col_dest),

  col_stops, MATCH("stops", rd_hdrs, 0),
  stops_raw, INDEX(rd_body, , col_stops),
  stops, MAX(0, IFERROR(VALUE(stops_raw), 0)),

  col_theme, IFERROR(MATCH("deal_theme", rd_hdrs, 0), IFERROR(MATCH("theme", rd_hdrs, 0), 0)),
  theme_raw, IF(col_theme=0, "", INDEX(rd_body, , col_theme)),
  theme, LOWER(theme_raw),

  rows, ROW(dest),

  count_back,
    COUNTIFS(
      dest, dest,
      rows, "<="&rows,
      rows, ">"&rows-100
    ),

  base_repeat_pen,
    IFS(
      count_back > 15, 30,
      count_back > 10, 15,
      count_back > 5,  5,
      TRUE, 0
    ),

  is_adv, (theme="adventure") + (theme="long_haul") > 0,

  stop_pen_gen,
    IF(stops<=0, 0,
      IF(stops=1, 10,
        IF(stops=2, 25, 45)
      )
    ),

  stop_pen_adv,
    IF(stops<=0, 0,
      IF(stops=1, 0,
        IF(stops=2, 10, 25)
      )
    ),

  IF(ids="", , base_repeat_pen + IF(is_adv, stop_pen_adv, stop_pen_gen))
))}

